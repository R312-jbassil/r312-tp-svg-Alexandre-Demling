---
import "../styles/global.css";
import { ui } from "../i18n/ui.js";

const user = Astro.locals.user;
const defaultLocale = 'en';
---

<!DOCTYPE html>
<html lang="en" class="h-full" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="generator" content={Astro.generator} />
    <title id="page-title">Site</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@3.8.0/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="h-full flex flex-col min-h-0">
    <!-- Header avec nav, langue et auth -->
    <header class="p-4 flex items-center justify-between bg-base-100 shadow">
      <nav class="flex gap-4 items-center">
        <a href="/" class="link" id="nav-home"></a>
        <a href="/generator" class="link" id="nav-generator"></a>
        <a href="/gallery" class="link" id="nav-gallery"></a>
      </nav>

      <div class="flex items-center gap-4">
        <!-- Sélecteur de langue -->
        <select id="language-select" class="select select-bordered select-sm">
          <option value="en">English</option>
          <option value="fr">Français</option>
        </select>

        <!-- Auth -->
        {user ? (
          <form method="POST" action="/api/logout" class="m-0 p-0">
            <button type="submit" class="btn btn-error btn-sm">
              Logout
            </button>
          </form>
        ) : (
          <div class="flex gap-2">
            <a href="/login" class="btn btn-primary btn-sm">Login</a>
            <a href="/signup" class="btn btn-secondary btn-sm">Signup</a>
          </div>
        )}
      </div>
    </header>

    <main class="flex-1 min-h-0">
      <slot />
    </main>

    <script type="module">
      import { ui } from '/src/i18n/ui.js';

      const select = document.getElementById('language-select');
      const savedLocale = localStorage.getItem('locale') || navigator.language.split('-')[0] || 'en';
      let locale = savedLocale === 'fr' ? 'fr' : 'en';
      select.value = locale;

      function applyTranslations() {
        document.documentElement.lang = locale;
        document.getElementById('page-title').textContent = ui[locale].nav.home;
        document.getElementById('nav-home').textContent = ui[locale].nav.home;
        document.getElementById('nav-generator').textContent = ui[locale].nav.generator;
        document.getElementById('nav-gallery').textContent = ui[locale].nav.gallery;

        // Traduire les éléments data-i18n
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.dataset.i18n;
          const parts = key.split('.');
          let value = ui[locale];
          parts.forEach(p => value = value[p]);
          if (value) el.textContent = value;
        });
      }

      select.addEventListener('change', (e) => {
        locale = e.target.value;
        localStorage.setItem('locale', locale);
        applyTranslations();
      });

      applyTranslations();
    </script>
  </body>
</html>
